import os

# =============================================================================
# 모델 및 Thinking Budget 설정
# =============================================================================

# 테스트용 모델 및 예산
TEST_MODELS = {
    "query_generation": "gemini-2.5-flash-lite-preview-06-17",
    "outline_generation": "gemini-2.5-flash-lite-preview-06-17",
    "draft_generation": "gemini-2.5-flash-lite-preview-06-17",
    "editorial_review": "gemini-2.5-flash-lite-preview-06-17",
    "final_formatting": "gemini-2.5-flash-lite-preview-06-17",
}
TEST_THINKING_BUDGETS = {
    "outline_generation": 0,
    "draft_generation": 0,
    "editorial_review": 8192,
    "final_formatting": 0,
}

# 프로덕션용 모델 및 예산
PRODUCTION_MODELS = {
    "query_generation": "gemini-2.5-pro",
    "outline_generation": "gemini-2.5-pro",
    "draft_generation": "gemini-2.5-pro",
    "editorial_review": "gemini-2.5-pro",  # 중요 작업은 Pro 유지
    "final_formatting": "gemini-2.5-pro",
}
PRODUCTION_THINKING_BUDGETS = {
    "outline_generation": 128,
    "draft_generation": 128,
    "editorial_review": 8192,
    "final_formatting": 128,
}

# 바이패스 모드용 모델
BYPASS_MODEL = "gemini-2.5-pro"  # Grounding을 지원하는 최신 모델 사용

# =============================================================================
# GCP 설정
# =============================================================================
GOOGLE_PROJECT_ID = os.getenv("GOOGLE_PROJECT_ID")

# =============================================================================
# 보고서 설정
# =============================================================================
REPORT_PURPOSE = "법률 보고서"  # 예: "시장 분석 보고서", "기술 동향 리포트" 등

# =============================================================================
# 편집 가이드라인
# =============================================================================
EDITORIAL_GUIDELINE = """
**보고서 작성 가이드라인:**
- **어조와 문체:** 전문가적이고 객관적인 어조를 유지합니다. 모든 서술은 '~이다', '~한다'와 같이 명료하고 간결한 문체로 통일합니다.
- **용어의 일관성:** 법률 용어 및 핵심 개념은 보고서 전체에 걸쳐 일관되게 사용합니다.
- **두괄식 서술:** 각 문단은 핵심 내용을 첫 문장에 제시하는 두괄식으로 구성하여 가독성을 높입니다.
- **객관적 서술:** 주관적인 의견이나 감정적인 표현은 배제하고, 사실과 데이터에 기반하여 서술합니다.
- **약어 사용:** 처음 등장하는 약어는 전체 이름과 함께 표기하고(예: Attorney-Client Privilege, ACP), 이후에는 약어로 통일합니다.
"""

# =============================================================================
# 프롬프트 템플릿
# =============================================================================

# 1. 개요 생성 프롬프트
OUTLINE_PROMPT_TEMPLATE = """
당신은 주어진 주제와 자료를 바탕으로, 매우 상세하고 체계적인 보고서의 목차를 설계하는 전문 기획자입니다.
당신의 목표는 최종 결과물이 깊이 있고, 논리적이며, 풍부한 내용을 담도록 만드는 것입니다.

--- 보고서 작성 목적 ---
이 보고서는 '{report_purpose}'입니다.

--- 사용자 작성 요청 ---
{topic}
--- 끝 ---

--- 편집 가이드라인 ---
{guideline}
--- 끝 ---

--- 참고 자료 (내부 데이터베이스) ---
{context_str}
--- 끝 ---

**지시사항:**
1. **요청 및 자료 완벽 반영:** '사용자 작성 요청'의 의도와 '참고 자료'의 모든 핵심 내용을 빠짐없이 반영하여 목차를 구성해야 합니다. 어떤 정보도 누락되어서는 안 됩니다.
2. **상세하고 깊이 있는 구조:** 단순한 목록이 아닌, 다중 레벨(장, 절, 소항목)을 갖는 상세한 구조를 설계해주세요. 각 항목이 충분한 내용을 담을 수 있도록 세분화해야 합니다.
3. **논리적 흐름:** 서론, 본론, 결론의 명확한 구조를 가지며, 독자가 자연스럽게 내용을 따라갈 수 있도록 논리적으로 전개되어야 합니다.
4. **결론 지향:** 결론 부분에는 '사용자 작성 요청'에 부합하는 분석, 제언, 또는 시사점이 포함되도록 설계해주세요.
5. **출력 형식:** 반드시 마크다운 형식으로 최종 목차를 출력해주세요.
"""

# 2. 섹션별 초안 작성 프롬프트
DRAFT_SECTION_PROMPT_TEMPLATE = """
당신은 주어진 자료를 바탕으로, 특정 주제에 대해 매우 상세하고 깊이 있는 글을 작성하는 전문 저술가입니다.
당신의 임무는 요청받은 섹션을 최대한 상세하고 풍부한 내용으로 채우는 것입니다.

--- 보고서 작성 목적 ---
이 보고서는 '{report_purpose}'입니다.

--- 전체 보고서 주제 ---
{topic}
--- 끝 ---

{improvement_prompt}

--- 편집 가이드라인 ---
{guideline}
--- 끝 ---

--- 참고 자료 ---
{context_str}
--- 끝 ---

**작성 지시사항:**
1.  **최대한 상세하게 작성:** '참고 자료'를 최대한 활용하여, 할당된 '{header}' 섹션에 대해 **매우 길고 상세한 본문**을 작성해야 합니다. 독자가 이 섹션만 읽어도 주제를 깊이 이해할 수 있도록 모든 관련 정보를 포함시켜 주세요. 최소 10개 이상의 문단으로 풍부하게 서술해야 합니다.
2.  **참고 자료 충실 활용:** 제시된 '참고 자료'의 내용을 빠짐없이, 그리고 정확하게 본문에 녹여내야 합니다. 단순한 요약을 넘어, 자료들을 서로 연결하고 비교 분석하여 깊이 있는 내용을 창출하세요.
3.  **각주 표기 규칙 (매우 중요):** 내용의 근거를 명확히 하기 위해, 참고한 자료의 `chunk_id`를 **반드시** `[^{{chunk_id}}]` 형식으로 문장 끝에 표기해야 합니다. 이 규칙은 절대적으로 지켜져야 합니다. 다른 형식(예: `[chunk_id]`)은 허용되지 않습니다. **이 규칙을 지키지 않으면 보고서 전체가 실패 처리됩니다.** 예시: "벨기에 법률은 사내변호사의 비밀유지권을 인정합니다.[^a1b2c3d4-e5f6-7890-1234-567890abcdef]"
4.  **제목 미포함:** 결과물에는 섹션 제목('{header}')을 절대 포함하지 마세요. 오직 본문 내용만 작성해야 합니다.
5.  **가이드라인 준수:** '편집 가이드라인'의 모든 규칙을 반드시 준수하여 작성해주세요.

이제, '{header}' 섹션에 대한 상세하고 깊이 있는 본문을 작성해주세요.
"""

# 3. 편집장 검토 프롬프트
EDITORIAL_REVIEW_PROMPT_TEMPLATE = """
당신은 품질 높은 보고서를 만들기 위해, 초안을 날카롭게 분석하고 구체적인 개선안을 제시하는 전문 편집장입니다.

--- 보고서 작성 목적 ---
이 보고서는 '{report_purpose}'입니다.

--- 전체 보고서 개요 ---
{outline}
--- 끝 ---

--- 편집 가이드라인 ---
{guideline}
--- 끝 ---

--- 작성된 보고서 초안 ---
{report_text}
--- 끝 ---

**검토 및 지시사항:**
1.  **심층 분석:** 초안을 '개요' 및 '가이드라인'과 비교하며, 논리적 비약, 내용의 부실함, 일관성 부족 등 개선이 필요한 모든 문제점을 찾아냅니다.
2.  **구체적 개선안 제시:** "내용 보강 필요"와 같은 추상적인 지시가 아닌, "A 섹션에 B 사례를 추가하고, C 관점에서의 분석을 보강해야 합니다"와 같이 **누가 읽어도 명확하게 이해하고 실행할 수 있는 구체적인 개선 지시사항**을 작성해야 합니다.
3.  **JSON 출력:** 검토 결과를 아래의 JSON 형식에 맞춰 정확하게 출력합니다. 개선할 부분이 없다면 `review_passed`를 `true`로 설정하고 `sections_to_improve`를 빈 리스트로 두세요.

**출력 JSON 형식:**
```json
{{
  "overall_comment": "보고서 전체에 대한 총평입니다. (예: 전반적인 구조는 잘 잡혀 있으나, 핵심 주장에 대한 근거 제시가 부족하여 분석의 깊이가 아쉽습니다.)",
  "review_passed": (true 또는 false),
  "sections_to_improve": [
    {{
      "section_header": "개선이 필요한 섹션의 정확한 제목",
      "improvement_instruction": "해당 섹션을 어떻게 개선해야 하는지에 대한 매우 구체적이고 실행 가능한 지시사항입니다."
    }}
  ]
}}
```
"""

# 4. 최종 서식 정리 프롬프트
FINAL_FORMATTING_PROMPT_TEMPLATE = """
당신은 최종 출판물을 만드는 전문 편집 디자이너입니다.
아래의 보고서 본문을 최종 제출 형식에 맞게 완벽하게 다듬어주세요.

--- 보고서 본문 ---
{report_text}
--- 끝 ---

--- 편집 가이드라인 ---
{guideline}
--- 끝 ---

**작업 지시사항:**
1. **완결성 있는 제목 추가:** 보고서의 전체 내용을 가장 잘 나타내는 전문적인 제목을 최상단에 `#` 마크다운으로 추가해주세요.
2. **전체 구조 검토 및 정리:** 문단과 문단 사이의 간격, 줄바꿈 등을 전체적으로 검토하여 가독성을 극대화해주세요.
3. **문체 및 표현 통일:** '편집 가이드라인'에 따라, 보고서 전체의 문체와 표현이 일관성을 갖도록 교정해주세요.
4. **오류 수정:** 불필요한 공백, 마크다운 문법 오류, 오탈자 등을 모두 수정하여 완벽한 상태로 만들어주세요.
5. **약어 중복 정의 수정 (매우 중요):** 보고서 전체를 확인하여, 동일한 약어(예: ACP)가 반복적으로 '전체 이름(약어)' 형식으로 정의되는 오류를 수정해주세요. 첫 번째 등장만 정의를 남기고, 이후에는 모두 약어(예: 'ACP')로 통일해야 합니다.
6. **각주 플레이스홀더 보존 (매우 중요):** 본문에 포함된 `[^{{...}}]` 형태의 각주 플레이스홀더는 절대 수정하거나 제거하지 마세요. 이들은 후속 단계에서 자동으로 실제 각주 번호로 변환될 예정입니다. 이 형식을 반드시 그대로 보존해야 합니다.

**출력:** 다른 부연 설명 없이, 오직 최종적으로 서식이 완벽하게 정리된 보고서 텍스트만을 출력해야 합니다.
"""


EMBEDDING_MODEL = "models/gemini-embedding-001"
MAX_REVIEW_ATTEMPTS = 3
NUM_CLUSTERS_FOR_OUTLINE = 15
K_FOR_TOPIC_SEARCH = 25
K_FOR_SECTION_DRAFT = 10
NUM_SEARCH_QUERIES = 5
